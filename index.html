<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD2 兌換碼監控終端</title>
    <style>
        :root { --primary: #007aff; --bg: #f5f5f7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2, h4 { margin-top: 0; color: #1d1d1f; }
        .btn { display: block; width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; box-sizing: border-box; }
        .btn:hover { opacity: 0.9; }
        .status-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .status-item:last-child { border-bottom: none; }
        .info { display: flex; flex-direction: column; }
        .name { font-weight: bold; font-size: 15px; }
        .code-text { font-size: 12px; color: #888; margin-top: 4px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .success { background: #e2fbe8; color: #28a745; }
        .waiting { background: #fff4e5; color: #ff9300; }
        .refresh-tip { text-align: center; font-size: 12px; color: #999; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>BD2 自动兑换终端</h2>
            <p style="font-size: 14px; color: #666;">只要在 codes.txt 中新增代码，系统就会自动为所有成员执行兑换。</p>
            <a href="codes.txt" target="_blank" class="btn">前往录入新兑换码</a>
            <p class="refresh-tip">修改文件并保存后，下方结果约在 3 分钟内更新</p>
        </div>

        <div class="card">
            <h4>兑换状态记录</h4>
            <div id="statusList">正在获取最新数据...</div>
        </div>
    </div>

    <script>
        async function loadHistory() {
            try {
                // 增加随机参数防止浏览器缓存
                const res = await fetch('history.json?t=' + Date.now());
                if (!res.ok) throw new Error();
                const data = await res.json();
                const list = document.getElementById('statusList');
                list.innerHTML = '';
                
                // 将结果按账号展示
                const keys = Object.keys(data).reverse(); // 最新的显示在上面
                if (keys.length === 0) {
                    list.innerHTML = "暂无记录，请先录入兑换码。";
                    return;
                }

                keys.forEach(key => {
                    const item = data[key];
                    list.innerHTML += `
                        <div class="status-item">
                            <div class="info">
                                <span class="name">${item.display}</span>
                                <span class="code-text">代码: ${item.code}</span>
                            </div>
                            <span class="badge success">${item.status}</span>
                        </div>
                    `;
                });
            } catch (e) {
                document.getElementById('statusList').innerHTML = 
                    `<div style="color:#999; text-align:center; padding: 20px;">
                        等待首次兑换任务完成...<br><small>结果生成后将自动显示在这里</small>
                    </div>`;
            }
        }

        loadHistory();
        // 每 60 秒自动刷新一次结果
        setInterval(loadHistory, 60000);
    </script>
</body>
</html>
